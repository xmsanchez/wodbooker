{% extends 'admin/model/list.html' %}
{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}
{% block model_menu_bar %}
  {% set error_ns = namespace(error=False) %}
  {% for row in data %}
    {% if row['is_active'] and not row['is_thread_active'] %}
      {% set error_ns.error = True %}
    {% endif %}
  {% endfor %}
  {% if error_ns.error %}
    <div class="alert alert-warning" role="alert">
      <h3>Debes revisar tus reservas</h3>
      <p>Las reservas marcadas con el símbolo <i style="color: #ffd241" class="bi bi-exclamation-triangle-fill"></i> están desactivadas porque se produjo algún error con las mismas. Para que vuelvan a estar activas, revisa el estado de las mismas y corrige los errores. Si el problema es derivado de que la sesión caducó, simplemente desactiva la reserva y vuelve a activarla.</p>
    </div>
  {% endif %}
  <div>
    <p class="text-right"><a class="btn btn-primary" href="{{ get_url('.create_view', url=return_url, modal=True) }}" role="button"><i class="bi bi-plus-square-fill"></i> Nueva Reserva</a></p>
  </div>
{% endblock %}
{% block model_list_table %}
  {% if not data %}
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-square"></i> Aún no tienes reservas creadas. Crea tu primera reserva <a href="{{ get_url('.create_view', url=return_url, modal=True) }}">aquí</a>.
    </div>
  {% else %}
    <div class="accordion" id="bookingsAccordion">
      {% set weekday_ns = namespace(current=None) %}
      {% for row in data %}
        {% set row_weekday_dow = row.dow %}
        {% if weekday_ns.current != row_weekday_dow %}
          {% set weekday_ns.current = row_weekday_dow %}
          {% set stats = weekday_stats.get(row_weekday_dow) or {'successful': 0, 'waiting': 0, 'errors': 0} %}
          <div class="weekday-header" style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; border-radius: 8px; padding: 0.5rem 1rem; margin-bottom: 0.5rem; margin-top: 0.75rem; font-weight: 600; color: #475569; font-size: 1rem;">
            <span>{{ DAYS_OF_WEEK[row_weekday_dow] }}</span>
            {% if stats['successful'] > 0 or stats['waiting'] > 0 or stats['errors'] > 0 %}
              <span style="font-size: 0.875rem; font-weight: 400; margin-left: 0.75rem;">
                {% if stats['successful'] > 0 %}
                  <span style="color: #059669;">Reservadas {{ stats['successful'] }}</span>
                {% endif %}
                {% if stats['waiting'] > 0 %}
                  {% if stats['successful'] > 0 %} / {% endif %}
                  <span style="color: #f59e0b;">Clase llena {{ stats['waiting'] }}</span>
                {% endif %}
                {% if stats['errors'] > 0 %}
                  {% if stats['successful'] > 0 or stats['waiting'] > 0 %} / {% endif %}
                  <span style="color: #dc2626;">Errores {{ stats['errors'] }}</span>
                {% endif %}
              </span>
            {% endif %}
          </div>
        {% endif %}
        {% set is_same_weekday_as_prev = loop.index0 > 0 and data[loop.index0 - 1].dow == row_weekday_dow %}
        <div class="card" style="margin-bottom: {% if is_same_weekday_as_prev %}0.25rem{% else %}0.5rem{% endif %};">
          <div class="card-header d-flex justify-content-between" id="heading{{row['id']}}" style="padding: 0.5rem 1rem;">
            <h2 class="mb-0 mr-auto" style="margin-bottom: 0;">
              <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse{{row['id']}}" aria-expanded="true" aria-controls="collapse{{row['id']}}" style="padding: 0; text-decoration: none;">
                  <h4 style="margin-bottom: 0.25rem; font-size: 1rem; font-weight: 600;">{{ get_value(row, 'time') }}
                    {% if row['is_active'] and not row['is_thread_active'] %}
                      <i style="color: #ffd241" class="bi bi-exclamation-triangle-fill"></i>
                    {% endif %}
                  </h4>
                <p style="margin-bottom: 0; font-size: 0.875rem; color: #64748b;">Apertura reserva: {{ get_value(row, 'available_at') }}</p>
              </button>
            </h2>
            {{ list_row_actions[2].render_ctx(get_pk_value(row), row) }}
            {{ list_row_actions[0].render_ctx(get_pk_value(row), row) }}
            {{ list_row_actions[1].render_ctx(get_pk_value(row), row) }}
          </div>
    
          <div id="collapse{{row['id']}}" class="collapse" aria-labelledby="heading{{row['id']}}" data-parent="#bookingsAccordion">
            <div class="card-body" style="padding: 0.75rem 1rem;">
              <div class="container-fluid" style="padding: 0;">
                <p style="margin-bottom: 0.5rem;">
                  <b>Box</b><br/>
                  <i class="bi bi-box-arrow-in-up-right"></i> <a href="{{ get_value(row, 'url') }}" target="_blank">{{ get_value(row, 'url') }}</a> 
                </p>
                <p style="margin-bottom: 0.5rem;">
                  <b>Activo</b><br/>
                  {{ "Sí" if row["is_active"] else "No" }}
                </p>
                <p style="margin-bottom: 0.5rem;">
                  <b>Apertura de reservas</b><br/>
                  {{ get_value(row, 'offset') }} a las {{ get_value(row, 'available_at') }}
                </p>  
                <p style="margin-bottom: 0.5rem;">
                  <b>Última reserva realizada</b><br/>
                  {% if row['last_book_date'] %}
                    {{ get_value(row, 'last_book_date') }}
                  {% else %}
                    <i>Ninguna</i>
                  {% endif %}
                </p>  
                <p style="margin-bottom: 0.5rem;">
                  <b>Estado</b><br/>
                  {% if row['last_events'] %}
                    {{ row['last_events'][0]['date'].strftime('%d/%m/%Y %H:%M') }}: 
                    {% for event in row['last_events'] %}
                      {{ event['event'].rstrip(".") }}.
                    {% endfor %}
                    <br /><a href="/event/?search=%3D{{row['id']}}">Ver todos <i class="bi bi-arrow-up-right"></i></a>
                  {% else %}
                    <i>Aún no hay eventos registrados para esta reserva. Los eventos aparecerán aquí cuando la reserva esté activa según vayan ocurriendo.</i>
                  {% endif %}
                </p>
                <p style="margin-bottom: 0;">
                  <b>Tipo de clase</b><br/>
                  {% if row['type_class'] %}
                    {% if row['type_class'] == 1 %}
                      OpenBox
                    {% else %}
                      Wod
                    {% endif %}
                  {% endif %}
                </p>  
              </div>
            </div>
          </div>
        </div>
    {% endfor %}
    </div>
  {% endif %}  
{% endblock %}