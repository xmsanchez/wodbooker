{% extends 'admin/model/list.html' %}
{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
{% endblock %}
{% block model_menu_bar %}
  {% set error_ns = namespace(error=False) %}
  {% for row in data %}
    {% if row['is_active'] and not row['is_thread_active'] %}
      {% set error_ns.error = True %}
    {% endif %}
  {% endfor %}
  {% if error_ns.error %}
    <div class="alert alert-warning" role="alert">
      <h3>Debes revisar tus reservas</h3>
      <p>Las reservas marcadas con el símbolo <i style="color: #ffd241" class="bi bi-exclamation-triangle-fill"></i> están desactivadas porque se produjo algún error con las mismas. Para que vuelvan a estar activas, revisa el estado de las mismas y corrige los errores. Si el problema es derivado de que la sesión caducó, simplemente desactiva la reserva y vuelve a activarla.</p>
    </div>
  {% endif %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center">
      {% if current_user.profile_picture_url %}
        <img src="{{ current_user.profile_picture_url }}" alt="Profile" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
      {% else %}
        <i class="bi bi-person-circle" style="font-size: 48px; color: #64748b;"></i>
      {% endif %}
    </div>
    <div class="d-flex gap-2">
      {% if current_user.athlete_id %}
        <form method="POST" action="{{ url_for('booking.sync_wodbuster_bookings_endpoint') }}" style="display: inline;">
          {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          {% endif %}
          <button type="submit" class="btn btn-outline-secondary btn-sm" title="Sincronizar reservas de WodBuster">
            <i class="bi bi-arrow-clockwise"></i> Sync WodBuster
          </button>
        </form>
      {% endif %}
      <a class="btn btn-primary" href="{{ get_url('.create_view', url=return_url, modal=True) }}" role="button"><i class="bi bi-plus-square-fill"></i> Nueva Reserva</a>
    </div>
  </div>
{% endblock %}
{% block model_list_table %}
  {% if not data %}
    <div class="alert alert-info" role="alert">
        <i class="bi bi-info-square"></i> Aún no tienes reservas creadas. Crea tu primera reserva <a href="{{ get_url('.create_view', url=return_url, modal=True) }}">aquí</a>.
    </div>
  {% else %}
    <div class="accordion" id="bookingsAccordion">
      {% set weekday_ns = namespace(current=None) %}
      {% for row in data %}
        {% set row_weekday_dow = row.dow %}
        {% if weekday_ns.current != row_weekday_dow %}
          {% set weekday_ns.current = row_weekday_dow %}
          {% set stats = weekday_stats.get(row_weekday_dow) or {'successful': 0, 'waiting': 0, 'errors': 0} %}
          <div class="weekday-header" style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; border-radius: 8px; padding: 0.5rem 1rem; margin-bottom: 0.5rem; margin-top: 0.75rem; font-weight: 600; color: #475569; font-size: 1rem;">
            <span>{{ DAYS_OF_WEEK[row_weekday_dow] }}</span>
            {% if stats['successful'] > 0 or stats['waiting'] > 0 or stats['errors'] > 0 %}
              <span style="font-size: 0.875rem; font-weight: 400; margin-left: 0.75rem;">
                {% if stats['successful'] > 0 %}
                  <span style="color: #059669;">Reservadas {{ stats['successful'] }}</span>
                {% endif %}
                {% if stats['waiting'] > 0 %}
                  {% if stats['successful'] > 0 %} / {% endif %}
                  <span style="color: #f59e0b;">Clase llena {{ stats['waiting'] }}</span>
                {% endif %}
                {% if stats['errors'] > 0 %}
                  {% if stats['successful'] > 0 or stats['waiting'] > 0 %} / {% endif %}
                  <span style="color: #dc2626;">Errores {{ stats['errors'] }}</span>
                {% endif %}
              </span>
            {% endif %}
          </div>
        {% endif %}
        {% set is_same_weekday_as_prev = loop.index0 > 0 and data[loop.index0 - 1].dow == row_weekday_dow %}
        <div class="card" style="margin-bottom: {% if is_same_weekday_as_prev %}0.25rem{% else %}0.5rem{% endif %};">
          <div class="card-header d-flex justify-content-between" id="heading{{row['id']}}" style="padding: 0.5rem 1rem;">
            <h2 class="mb-0 mr-auto" style="margin-bottom: 0;">
              <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapse{{row['id']}}" aria-expanded="true" aria-controls="collapse{{row['id']}}" style="padding: 0; text-decoration: none;">
                  <h4 style="margin-bottom: 0.25rem; font-size: 1rem; font-weight: 600;">{{ get_value(row, 'time') }}
                    {% if row['is_active'] and not row['is_thread_active'] %}
                      <i style="color: #ffd241" class="bi bi-exclamation-triangle-fill"></i>
                    {% endif %}
                  </h4>
                <p style="margin-bottom: 0; font-size: 0.875rem; color: #64748b;">Apertura reserva: {{ get_value(row, 'available_at') }}</p>
              </button>
            </h2>
            {{ list_row_actions[2].render_ctx(get_pk_value(row), row) }}
            {{ list_row_actions[0].render_ctx(get_pk_value(row), row) }}
            {{ list_row_actions[1].render_ctx(get_pk_value(row), row) }}
          </div>
    
          <div id="collapse{{row['id']}}" class="collapse" aria-labelledby="heading{{row['id']}}" data-parent="#bookingsAccordion">
            <div class="card-body" style="padding: 0.75rem 1rem;">
              <div class="container-fluid" style="padding: 0;">
                <p style="margin-bottom: 0.5rem;">
                  <b>Box</b><br/>
                  <i class="bi bi-box-arrow-in-up-right"></i> <a href="{{ get_value(row, 'url') }}" target="_blank">{{ get_value(row, 'url') }}</a> 
                </p>
                <p style="margin-bottom: 0.5rem;">
                  <b>Activo</b><br/>
                  {{ "Sí" if row["is_active"] else "No" }}
                </p>
                <p style="margin-bottom: 0.5rem;">
                  <b>Apertura de reservas</b><br/>
                  {{ get_value(row, 'offset') }} a las {{ get_value(row, 'available_at') }}
                </p>  
                <p style="margin-bottom: 0.5rem;">
                  <b>Última reserva realizada</b><br/>
                  {% if row['last_book_date'] %}
                    {{ get_value(row, 'last_book_date') }}
                  {% else %}
                    <i>Ninguna</i>
                  {% endif %}
                </p>  
                <p style="margin-bottom: 0.5rem;">
                  <b>Estado</b><br/>
                  {% if row['last_events'] %}
                    {{ row['last_events'][0]['date'].strftime('%d/%m/%Y %H:%M') }}: 
                    {% for event in row['last_events'] %}
                      {{ event['event'].rstrip(".") }}.
                    {% endfor %}
                    <br /><a href="/event/?search=%3D{{row['id']}}">Ver todos <i class="bi bi-arrow-up-right"></i></a>
                  {% else %}
                    <i>Aún no hay eventos registrados para esta reserva. Los eventos aparecerán aquí cuando la reserva esté activa según vayan ocurriendo.</i>
                  {% endif %}
                </p>
                <p style="margin-bottom: 0;">
                  <b>Tipo de clase</b><br/>
                  {% if row['type_class'] %}
                    {% if row['type_class'] == 1 %}
                      OpenBox
                    {% else %}
                      Wod
                    {% endif %}
                  {% endif %}
                </p>  
              </div>
            </div>
          </div>
        </div>
    {% endfor %}
    </div>
  {% endif %}
  
  {% if wodbuster_bookings %}
    <div class="mt-4">
      <h3 style="font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem;">
        <i class="bi bi-calendar-check me-2"></i>Reservas de WodBuster (Semana actual)
      </h3>
      <div class="accordion" id="wodbusterBookingsAccordion">
        {% set wb_date_ns = namespace(current=None) %}
        {% for wb_booking in wodbuster_bookings %}
          {% set wb_date = wb_booking.class_date %}
          {% set wb_dow = wb_date.weekday() %}
          {% if wb_date_ns.current != wb_date %}
            {% set wb_date_ns.current = wb_date %}
            <div class="weekday-header" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 1px solid #93c5fd; border-radius: 8px; padding: 0.5rem 1rem; margin-bottom: 0.5rem; margin-top: 0.75rem; font-weight: 600; color: #1e40af; font-size: 1rem;">
              <span>{{ DAYS_OF_WEEK[wb_dow] }} {{ wb_date.strftime('%d/%m/%Y') }}</span>
            </div>
          {% endif %}
          {% set is_same_date_as_prev = loop.index0 > 0 and wodbuster_bookings[loop.index0 - 1].class_date == wb_date %}
          <div class="card" style="margin-bottom: {% if is_same_date_as_prev %}0.25rem{% else %}0.5rem{% endif %}; border-left: 4px solid #3b82f6;">
            <div class="card-header d-flex justify-content-between" id="headingWB{{wb_booking.id}}" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);">
              <h2 class="mb-0 mr-auto" style="margin-bottom: 0;">
                <button class="btn btn-link btn-block text-left" type="button" data-toggle="collapse" data-target="#collapseWB{{wb_booking.id}}" aria-expanded="false" aria-controls="collapseWB{{wb_booking.id}}" style="padding: 0; text-decoration: none;">
                  <h4 style="margin-bottom: 0.25rem; font-size: 1rem; font-weight: 600;">
                    {{ wb_booking.class_time.strftime('%H:%M') }}
                    <span class="badge badge-info" style="background-color: #3b82f6; color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; margin-left: 0.5rem;">WodBuster</span>
                  </h4>
                  <p style="margin-bottom: 0; font-size: 0.875rem; color: #64748b;">
                    {{ wb_booking.class_name }} {{ wb_booking.class_type or 'N/A' }}
                  </p>
                </button>
              </h2>
            </div>
            <div id="collapseWB{{wb_booking.id}}" class="collapse" aria-labelledby="headingWB{{wb_booking.id}}" data-parent="#wodbusterBookingsAccordion">
              <div class="card-body" style="padding: 0.75rem 1rem;">
                <div class="container-fluid" style="padding: 0;">
                  <p style="margin-bottom: 0.5rem;">
                    <b>Fecha</b><br/>
                    {{ wb_booking.class_date.strftime('%d/%m/%Y') }}
                  </p>
                  <p style="margin-bottom: 0.5rem;">
                    <b>Hora</b><br/>
                    {{ wb_booking.class_time.strftime('%H:%M') }}
                  </p>
                  <p style="margin-bottom: 0.5rem;">
                    <b>Clase</b><br/>
                    {{ wb_booking.class_name }}
                  </p>
                  <p style="margin-bottom: 0.5rem;">
                    <b>Tipo</b><br/>
                    {{ wb_booking.class_type or 'N/A' }}
                  </p>
                  <p style="margin-bottom: 0.5rem;">
                    <b>Box</b><br/>
                    <i class="bi bi-box-arrow-in-up-right"></i> <a href="{{ wb_booking.box_url }}" target="_blank">{{ wb_booking.box_url }}</a>
                  </p>
                  <p style="margin-bottom: 0;">
                    <b>Sincronizado</b><br/>
                    {{ wb_booking.fetched_at.strftime('%d/%m/%Y %H:%M') if wb_booking.fetched_at else 'N/A' }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  
  <!-- Auto-sync loading indicator -->
  <div id="autosync-loading" style="display: none; text-align: center; padding: 10px;">
    <i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite;"></i> Sincronizando reservas de WodBuster...
  </div>
  
  <style>
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
  
  <script>
    // Set auto-sync enabled flag for autosync.js
    {% if current_user.is_authenticated and current_user.wodbuster_autosync_enabled %}
      window.AUTOSYNC_ENABLED = true;
    {% else %}
      window.AUTOSYNC_ENABLED = false;
    {% endif %}
    
    // Set CSRF token for AJAX requests
    {% if csrf_token %}
      window.CSRF_TOKEN = '{{ csrf_token() }}';
    {% endif %}
  </script>
{% endblock %}